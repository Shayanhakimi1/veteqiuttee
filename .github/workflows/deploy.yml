name: Deploy to Tegrahost

# ØªØ±ÛŒÚ¯Ø±Ù‡Ø§ÛŒ Ø§Ø¬Ø±Ø§
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ

# Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ
env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Job ØªØ³Øª Ùˆ Ø¨ÛŒÙ„Ø¯
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          backend/package-lock.json
          pet-consultation/package-lock.json
    
    # Backend Build
    - name: Install Backend Dependencies
      run: |
        cd backend
        npm ci
        
    - name: Run Backend Tests
      run: |
        cd backend
        npm test || echo "No tests found"
        
    - name: Build Backend
      run: |
        cd backend
        npm run build
        
    - name: Generate Prisma Client
      run: |
        cd backend
        npx prisma generate
    
    # Frontend Build
    - name: Install Frontend Dependencies
      run: |
        cd pet-consultation
        npm ci
        
    - name: Run Frontend Tests
      run: |
        cd pet-consultation
        npm test || echo "No tests found"
        
    - name: Build Frontend
      run: |
        cd pet-consultation
        npm run build
    
    # Ø¢Ù¾Ù„ÙˆØ¯ artifacts
    - name: Upload Backend Build
      uses: actions/upload-artifact@v4
      with:
        name: backend-build
        path: |
          backend/dist/
          backend/package.json
          backend/prisma/
        retention-days: 1
        
    - name: Upload Frontend Build
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: pet-consultation/dist/
        retention-days: 1

  # Job Ø¯ÛŒÙ¾Ù„ÙˆÛŒ (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ main branch)
  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: production
      url: https://${{ secrets.DOMAIN }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download Backend Build
      uses: actions/download-artifact@v4
      with:
        name: backend-build
        path: backend-build/
        
    - name: Download Frontend Build
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: frontend-build/
    
    # Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ø¨Ø§ SSH
    - name: Deploy to Tegrahost
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          set -e
          
          # Ù…ØªØºÛŒØ±Ù‡Ø§
          PROJECT_PATH="/home/${{ secrets.SSH_USERNAME }}/domains/${{ secrets.DOMAIN }}/public_html"
          API_PATH="$PROJECT_PATH/api"
          BACKUP_PATH="/home/${{ secrets.SSH_USERNAME }}/backups"
          
          echo "ğŸš€ Ø´Ø±ÙˆØ¹ Ø¯ÛŒÙ¾Ù„ÙˆÛŒ..."
          
          # Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø´ØªÛŒØ¨Ø§Ù†
          echo "ğŸ“¦ Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø´ØªÛŒØ¨Ø§Ù†..."
          mkdir -p $BACKUP_PATH
          if [ -d "$PROJECT_PATH" ]; then
            tar -czf "$BACKUP_PATH/backup_$(date +%Y%m%d_%H%M%S).tar.gz" -C "$PROJECT_PATH" . || echo "Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ"
          fi
          
          # Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø³ÛŒØ±Ù‡Ø§
          mkdir -p $PROJECT_PATH
          mkdir -p $API_PATH
          
          # Ú©Ù„ÙˆÙ† ÛŒØ§ Ø¢Ù¾Ø¯ÛŒØª Ú©Ø¯
          echo "ğŸ“¥ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ Ø¬Ø¯ÛŒØ¯..."
          if [ -d "$PROJECT_PATH/.git" ]; then
            cd $PROJECT_PATH
            git fetch origin
            git reset --hard origin/main
            git clean -fd
          else
            rm -rf $PROJECT_PATH/*
            git clone ${{ github.server_url }}/${{ github.repository }}.git $PROJECT_PATH
            cd $PROJECT_PATH
          fi
          
          # Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ backend
          echo "ğŸ“¦ Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ backend..."
          cd $PROJECT_PATH/backend
          npm install --production --silent
          
          # Ø¨ÛŒÙ„Ø¯ backend
          echo "ğŸ”¨ Ø¨ÛŒÙ„Ø¯ backend..."
          npm run build
          
          # ØªÙ†Ø¸ÛŒÙ… Prisma
          echo "ğŸ—„ï¸ ØªÙ†Ø¸ÛŒÙ… Prisma..."
          npx prisma generate
          
          # Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ frontend
          echo "ğŸ“¦ Ù†ØµØ¨ ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§ÛŒ frontend..."
          cd $PROJECT_PATH/pet-consultation
          npm install --silent
          
          # Ø¨ÛŒÙ„Ø¯ frontend
          echo "ğŸ”¨ Ø¨ÛŒÙ„Ø¯ frontend..."
          npm run build
          
          # Ú©Ù¾ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
          echo "ğŸ“ Ú©Ù¾ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§..."
          # Frontend files
          cp -r $PROJECT_PATH/pet-consultation/dist/* $PROJECT_PATH/
          
          # Backend files
          cp -r $PROJECT_PATH/backend/dist/* $API_PATH/
          cp $PROJECT_PATH/backend/package.json $API_PATH/
          cp -r $PROJECT_PATH/backend/prisma $API_PATH/
          
          # ØªÙ†Ø¸ÛŒÙ… environment variables
          echo "âš™ï¸ ØªÙ†Ø¸ÛŒÙ… Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ..."
          cat > $API_PATH/.env << EOF
          DATABASE_URL="${{ secrets.DATABASE_URL }}"
          JWT_SECRET="${{ secrets.JWT_SECRET }}"
          NODE_ENV="production"
          PORT=3001
          EOF
          
          # ØªÙ†Ø¸ÛŒÙ… Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§
          echo "ğŸ” ØªÙ†Ø¸ÛŒÙ… Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§..."
          find $PROJECT_PATH -type f -exec chmod 644 {} \;
          find $PROJECT_PATH -type d -exec chmod 755 {} \;
          chmod 600 $API_PATH/.env
          
          # Ø§ÛŒØ¬Ø§Ø¯ .htaccess
          echo "ğŸ“ Ø§ÛŒØ¬Ø§Ø¯ .htaccess..."
          cat > $PROJECT_PATH/.htaccess << 'HTACCESS_EOF'
          # ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ
          ServerTokens Prod
          ServerSignature Off
          
          # Ù…Ø­Ø§ÙØ¸Øª Ø§Ø² ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø³
          <Files ".env">
              Order allow,deny
              Deny from all
          </Files>
          
          # ÙØ´Ø±Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ
          <IfModule mod_deflate.c>
              AddOutputFilterByType DEFLATE text/plain
              AddOutputFilterByType DEFLATE text/html
              AddOutputFilterByType DEFLATE text/css
              AddOutputFilterByType DEFLATE application/javascript
          </IfModule>
          
          # Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ API
          RewriteEngine On
          RewriteRule ^api/(.*)$ http://localhost:3001/$1 [P,L]
          
          # SPA routing
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule . /index.html [L]
          HTACCESS_EOF
          
          # Ù†ØµØ¨ PM2 Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
          if ! command -v pm2 &> /dev/null; then
            echo "ğŸ“¦ Ù†ØµØ¨ PM2..."
            npm install -g pm2
          fi
          
          # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ø³Ø±ÙˆØ±
          echo "ğŸ”„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ø³Ø±ÙˆØ±..."
          cd $API_PATH
          pm2 stop veteqiutte-api 2>/dev/null || true
          pm2 delete veteqiutte-api 2>/dev/null || true
          pm2 start server.js --name "veteqiutte-api" --env production
          pm2 save
          
          # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ
          echo "ğŸ§¹ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ..."
          rm -rf $PROJECT_PATH/backend/node_modules
          rm -rf $PROJECT_PATH/pet-consultation/node_modules
          rm -rf $PROJECT_PATH/backend/src
          rm -rf $PROJECT_PATH/pet-consultation/src
          
          echo "âœ… Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!"
          
          # ØªØ³Øª Ø¹Ù…Ù„Ú©Ø±Ø¯
          echo "ğŸ§ª ØªØ³Øª Ø¹Ù…Ù„Ú©Ø±Ø¯..."
          sleep 5
          
          if curl -f -s "http://localhost:3001/health" > /dev/null; then
            echo "âœ… API Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø§Ø³Øª"
          else
            echo "âš ï¸ API Ù¾Ø§Ø³Ø® Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ø¯"
          fi
          
          pm2 status
    
    # Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ
    - name: Notify Success
      if: success()
      run: |
        echo "âœ… Ø¯ÛŒÙ¾Ù„ÙˆÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!"
        echo "ğŸŒ Ø¢Ø¯Ø±Ø³ Ø³Ø§ÛŒØª: https://${{ secrets.DOMAIN }}"
        echo "ğŸ”— Ø¢Ø¯Ø±Ø³ API: https://${{ secrets.DOMAIN }}/api"
    
    - name: Notify Failure
      if: failure()
      run: |
        echo "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯ÛŒÙ¾Ù„ÙˆÛŒ!"
        echo "Ù„Ø·ÙØ§Ù‹ Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."

  # Job ØªØ³Øª Ù¾Ø³ Ø§Ø² Ø¯ÛŒÙ¾Ù„ÙˆÛŒ
  post-deploy-test:
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Test Deployment
      run: |
        echo "ğŸ§ª ØªØ³Øª Ø¯ÛŒÙ¾Ù„ÙˆÛŒ..."
        
        # ØªØ³Øª API health endpoint
        if curl -f -s "https://${{ secrets.DOMAIN }}/api/health" > /dev/null; then
          echo "âœ… API health check Ù…ÙˆÙÙ‚"
        else
          echo "âŒ API health check Ù†Ø§Ù…ÙˆÙÙ‚"
          exit 1
        fi
        
        # ØªØ³Øª frontend
        if curl -f -s "https://${{ secrets.DOMAIN }}" > /dev/null; then
          echo "âœ… Frontend Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ø§Ø³Øª"
        else
          echo "âŒ Frontend Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª"
          exit 1
        fi
        
        echo "âœ… Ù‡Ù…Ù‡ ØªØ³Øªâ€ŒÙ‡Ø§ Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯Ù†Ø¯!"
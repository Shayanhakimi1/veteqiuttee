import{r as i,d as x,u as S,b as j,j as e,t as d,e as v,l as w}from"./index-BgTIe4Qm.js";import{L as E}from"./LoadingSpinner-Bc9-TOfe.js";const T=()=>{const[g,h]=i.useState("در حال تأیید پرداخت..."),[l,n]=i.useState(""),m=x(),s=S(),{isAuthenticated:u}=j(),p=()=>{try{const a=localStorage.getItem("consultationData");return a?JSON.parse(a):null}catch(a){return w.error("Failed to read consultation data from localStorage",{error:a}),null}};return i.useEffect(()=>{if(!u){s("/login");return}const a=async()=>{const t=new URLSearchParams(m.search),c=t.get("Status"),f=t.get("Authority");if(c!=="OK"){n("پرداخت توسط کاربر لغو شد یا در انجام آن خطایی رخ داده است."),setTimeout(()=>s("/payment"),3e3);return}try{const r=await fetch("/api/payments/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({authority:f,amount:28e4})}),o=await r.json();if(r.ok&&o.success)h("پرداخت با موفقیت تأیید شد. در حال ثبت نهایی اطلاعات..."),await y(),s("/payment-success");else throw new Error(o.message||"خطا در تأیید پرداخت")}catch(r){const o=d(r.message);n(`خطا: ${o}`),setTimeout(()=>s("/payment"),5e3)}},y=async()=>{try{const t=p();if(!t)throw new Error("اطلاعات لازم برای ثبت مشاوره کامل نیست.");await v.create(t),localStorage.removeItem("consultationData"),localStorage.removeItem("appointmentTime")}catch(t){const c=d(t.message);n(`پرداخت شما موفق بود، اما در ثبت نهایی مشاوره خطایی رخ داد: ${c}. لطفاً با پشتیبانی تماس بگیرید.`),setTimeout(()=>s("/dashboard"),8e3)}};a()},[m,s,u]),e.jsx("div",{className:"flex flex-col items-center justify-center min-h-screen bg-gray-50",children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx(E,{}),e.jsx("h1",{className:"text-2xl font-semibold text-gray-800 mt-6",children:g}),l&&e.jsxs("div",{className:"mt-4 text-red-600 bg-red-100 p-4 rounded-lg",children:[e.jsx("p",{children:l}),e.jsx("p",{children:"شما تا چند لحظه دیگر به صفحه پرداخت منتقل خواهید شد."})]})]})})};export{T as default};
